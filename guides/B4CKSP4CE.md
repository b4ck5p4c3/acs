# Основные действия с системой автоматизации
В этом документе описываются инструкции по основным взаимодействиям с системой автоматизации (СКУДом).

-----

## Как получить доступ к Node-RED
Доступ к интерфейсу управления Node-RED закрыт снаружи. 
Для подключения к веб-интерфейсу, необходим туннель до Corleone (RPi 3B на которой работает автоматизация)
и подключение через Teleport.

```bash
tsh ssh -L 1880:127.0.0.1:1880 pi@corleone
```

Далее, откройте в браузере [http://localhost:1880](http://localhost:1880) и аутентифицируйтесь, 
используя данные для доступа из кейчейна KeepassXC.

-----

## Как добавить новый пропуск?
Залогиньтесь на Corleone по SSH (`tsh ssh pi@corleone`) и прочтите `/home/pi/HOW_TO_ADD_RFID.md`.
-----

## Как сохранить изменения в сценариях автоматизации?
Если вы внесли какие-то изменения в сценарии автоматизации, которые хотите сохранить, то вам нужно:

  1. Экспортировать изменённый граф. Для этого, в интерфейсе Node-RED нажмите на иконку меню (в правом верхнем углу),
     выберите пункт "Export".

  2. В появившемся модальном окне, выберите режим экспорта **"all flows"**, форматирование — **"formatted"**. 
  Опция форматирования спрятана внизу вкладки JSON:
  ![NodeRed export](./nodered_export.png)

  3. Нажмите на кнопку "Download" и сохраните файл flows.json.

  4. Переместите сохранённый файл в этот репозиторий как `software/nodered/flowgraphs/main.json`

  5. Закоммитьте новый `main.json`, описав внесённые изменения в multiline commit message. В первой строке должно быть краткое описание 
     изменений (например, "Добавлено включение вентиляции по датчику CO2"), в последующих — подробное описание 
     изменений и затронутых flows (например, "Добавлен Flow "Ventilation automation" с обработкой данных от датчика.
     Добавлен subflow "Activate ventillation" реализующий логику открытия/закрытия вентиляции).

  6. Не забудьте запушить закомиченные изменения.
